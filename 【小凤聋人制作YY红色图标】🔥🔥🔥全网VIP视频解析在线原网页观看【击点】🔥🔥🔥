// ==UserScript==
// @name         ã€å°å‡¤è‹äººåˆ¶ä½œYYçº¢è‰²å›¾æ ‡ã€‘ğŸ”¥ğŸ”¥ğŸ”¥å…¨ç½‘VIPè§†é¢‘è§£æåœ¨çº¿åŸç½‘é¡µè§‚çœ‹ã€å‡»ç‚¹ã€‘ğŸ”¥ğŸ”¥ğŸ”¥
// @namespace   wntcy
// @version      2025å¹´3æœˆ14æ—¥ï¼šç‰ˆæœ¬2.7.11
//@icon         https://qlogo2.store.qq.com/qzone/157903109/157903109/50?1663513516
// @description  ä¼˜é…· çˆ±å¥‡è‰º è…¾è®¯ èŠ’æœ ABç«™ç­‰å…¨ç½‘VIPè§†é¢‘å…è´¹è§£æ
// @author       w
// @license      MIT
// @include      *://m.youku.com/v*
// @include      *://m.youku.com/a*
// @include      *://v.youku.com/v_*
// @include      *://*.iqiyi.com/v_*
// @include      *://*.iqiyi.com/w_*
// @include      *://*.iqiyi.com/a_*
// @include      *://*.iqiyi.com/adv*
// @include      *://*.le.com/ptv/vplay/*
// @include      *v.qq.com/x/cover/*
// @include      *v.qq.com/x/page/*
// @include      *v.qq.com/play*
// @include      *v.qq.com/cover*
// @include      *://*.tudou.com/listplay/*
// @include      *://*.tudou.com/albumplay/*
// @include      *://*.tudou.com/programs/view/*
// @include      *://*.tudou.com/v*
// @include      *://*.mgtv.com/b/*
// @include      *://film.sohu.com/album/*
// @include      *://tv.sohu.com/v/*
// @include      *://*.acfun.cn/v/*
// @include      *://*.bilibili.com/video/*
// @include      *://*.bilibili.com/anime/*
// @include      *://*.bilibili.com/bangumi/play/*
// @include      *://*.pptv.com/show/*
// @include      *://*.baofeng.com/play/*
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // æ·»åŠ æ ·å¼
    GM_addStyle(`
        .vip-button {
            position: fixed;
            top: 120px;
            left: 10px;
            z-index: 2147483647;
            background: #FF4D4F;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .vip-button:hover {
            background: #FF7875;
            transform: scale(1.05);
        }

        .restore-button {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 2147483647;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .restore-button:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        .player-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2147483646;
        }

        /* å±è”½å¹¿å‘Šå¼¹çª—ï¼Œä½†ä¿æŠ¤è§†é¢‘æ’­æ”¾å™¨ */
        div[style*="position: fixed"]:not(.player-container),
        div[style*="position:fixed"]:not(.player-container),
        div[style*="z-index"]:not(.player-container):not(.player-iframe),
        a[href*="visitor.html"],
        a[href*="evewan.com"],
        a[target="_blank"]:not(.player-container *),
        img[src*=".gif"]:not(.player-container *),
        div > a[target="_blank"] > img,
        iframe:not(.player-iframe) {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            width: 0 !important;
            height: 0 !important;
            max-width: 0 !important;
            max-height: 0 !important;
            position: absolute !important;
            left: -99999px !important;
            pointer-events: none !important;
            z-index: -9999 !important;
        }

        /* ç¡®ä¿æ’­æ”¾å™¨æ­£å¸¸æ˜¾ç¤º */
        .player-container,
        .player-iframe {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 2147483646 !important;
            pointer-events: auto !important;
        }

        /* ä¸“é—¨é’ˆå¯¹å¹¿å‘Šå…ƒç´ çš„æ ·å¼ */
        #hmhrefurl,
        #hmhrefurl * {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -99999px !important;
            z-index: -9999 !important;
            width: 0 !important;
            height: 0 !important;
        }
    `);

    // è·å–è§†é¢‘ç½‘ç«™æ’­æ”¾å™¨ä¿¡æ¯
    const playerConfig = {
        'iqiyi.com': {
            container: '#flashbox',
            containers: ['#flashbox', '#playerbox', '#iframePlayer', '#video', '.iqp-player', '#player'],
            width: '100%',
            height: '100%'
        },
        'v.qq.com': {
            container: '#player-container',
            containers: ['#tenvideo_player', '#player-container'],
            width: '100%',
            height: '100%'
        },
        'youku.com': {
            container: '#player',
            containers: ['#ykPlayer', '#player'],
            width: '100%',
            height: '100%'
        },
        'mgtv.com': {
            container: '#mgtv-player-wrap',
            containers: ['#mgtv-player-wrap', '#player-container'],
            width: '100%',
            height: '100%'
        },
        'bilibili.com': {
            container: '#player_module',
            containers: ['#player_module', '#bilibili-player'],
            width: '100%',
            height: '100%'
        },
        'sohu.com': {
            container: '#player',
            containers: ['#player', '#16x9Container'],
            width: '100%',
            height: '100%'
        },
        'le.com': {
            container: '#le_playbox',
            containers: ['#le_playbox', '#player'],
            width: '100%',
            height: '100%'
        },
        'pptv.com': {
            container: '#pptv_playpage_box',
            containers: ['#pptv_playpage_box', '#player-container'],
            width: '100%',
            height: '100%'
        },
        'acfun.cn': {
            container: '#player',
            containers: ['#player', '#container'],
            width: '100%',
            height: '100%'
        }
    };

    // è·å–å½“å‰ç½‘ç«™çš„æ’­æ”¾å™¨é…ç½®
    function getPlayerConfig() {
        const hostname = window.location.hostname;
        for (let site in playerConfig) {
            if (hostname.includes(site)) {
                return playerConfig[site];
            }
        }
        return null;
    }

    // è·å–æ’­æ”¾å™¨å®¹å™¨
    function getPlayerContainer() {
        const config = getPlayerConfig();
        if (!config) return null;

        // é¦–å…ˆå°è¯•ä½¿ç”¨é…ç½®çš„é€‰æ‹©å™¨
        for (let container of config.containers) {
            const element = document.querySelector(container);
            if (element) {
                return element;
            }
        }

        // å¦‚æœæ˜¯çˆ±å¥‡è‰ºï¼Œæ·»åŠ é¢å¤–çš„æŸ¥æ‰¾é€»è¾‘
        if (window.location.hostname.includes('iqiyi.com')) {
            // æŸ¥æ‰¾åŒ…å«ç‰¹å®šç±»åçš„æ’­æ”¾å™¨å®¹å™¨
            const containers = [
                document.querySelector('.iqp-player'),
                document.querySelector('[class*="player"]'), // æŸ¥æ‰¾ç±»ååŒ…å«playerçš„å…ƒç´ 
                document.querySelector('[id*="player"]'),    // æŸ¥æ‰¾idåŒ…å«playerçš„å…ƒç´ 
                document.querySelector('video'),             // ç›´æ¥æŸ¥æ‰¾videoæ ‡ç­¾
            ];

            for (let container of containers) {
                if (container) {
                    return container;
                }
            }
        }

        return null;
    }

    // åˆ›å»ºè§†é¢‘æ’­æ”¾å™¨
    function createVideoPlayer() {
        const container = getPlayerContainer();
        if (!container) {
            alert('æœªæ‰¾åˆ°æ’­æ”¾å™¨å®¹å™¨');
            return;
        }

        const config = getPlayerConfig();
        if (!config) return;

        // ä¿å­˜åŸå§‹å†…å®¹å’Œæ ·å¼
        window.originalContent = container.innerHTML;
        window.originalStyle = {
            position: container.style.position,
            width: container.style.width,
            height: container.style.height
        };

        // è®¾ç½®å®¹å™¨æ ·å¼
        container.style.position = 'relative';
        container.style.width = config.width;
        container.style.height = config.height;
        container.classList.add('player-container');

        // åˆ›å»ºiframe
        const iframe = document.createElement('iframe');
        iframe.className = 'player-iframe';
        iframe.allowFullscreen = true;
        iframe.sandbox = 'allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox';

        // è®¾ç½®è§£ææ¥å£URL
        const videoUrl = 'https://jx.yparse.com/index.php?url=' + encodeURIComponent(window.location.href);
        iframe.src = videoUrl;

        // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°å…ƒç´ 
        container.innerHTML = '';
        container.appendChild(iframe);

        // æ·»åŠ å¹¿å‘Šåˆ é™¤åŠŸèƒ½
        function removeAd() {
            const adElement = document.querySelector("#hmhrefurl");
            if (adElement) {
                // å…ˆç¦ç”¨å¹¿å‘Šå…ƒç´ 
                adElement.style.cssText = `
                    display: none !important;
                    opacity: 0 !important;
                    visibility: hidden !important;
                    pointer-events: none !important;
                    position: absolute !important;
                    left: -99999px !important;
                    z-index: -9999 !important;
                    width: 0 !important;
                    height: 0 !important;
                `;
                // ç„¶åç§»é™¤
                setTimeout(() => adElement.remove(), 100);
            }
        }

        // æ›´é¢‘ç¹åœ°æ£€æŸ¥å¹¿å‘Š
        const adCheckInterval = setInterval(removeAd, 500);

        // åœ¨iframeåŠ è½½å®Œæˆå’Œè§†é¢‘æ’­æ”¾çŠ¶æ€å˜åŒ–æ—¶æ£€æŸ¥å¹¿å‘Š
        iframe.addEventListener('load', removeAd);
        document.addEventListener('play', removeAd, true);
        document.addEventListener('pause', removeAd, true);

        return iframe;
    }

    // æ·»åŠ æ¢å¤åŸè§†é¢‘çš„å‡½æ•°
    function restoreOriginalVideo() {
        const container = getPlayerContainer();
        if (!container) return;

        // æ¢å¤åŸå§‹å†…å®¹å’Œæ ·å¼
        if (window.originalContent) {
            container.innerHTML = window.originalContent;
        }
        if (window.originalStyle) {
            Object.assign(container.style, window.originalStyle);
        }
        container.classList.remove('player-container');
    }

    // åˆ›å»ºè§£ææŒ‰é’®
    function createButtons() {
        // åˆ›å»ºVIPè§£ææŒ‰é’®
        const vipButton = document.createElement('button');
        vipButton.className = 'vip-button';
        vipButton.innerHTML = 'VIPè§†é¢‘è§£æ';
        document.body.appendChild(vipButton);

        // åˆ›å»ºæ¢å¤åŸè§†é¢‘æŒ‰é’®ï¼ˆåˆå§‹éšè—ï¼‰
        const restoreButton = document.createElement('button');
        restoreButton.className = 'restore-button';
        restoreButton.innerHTML = 'æ¢å¤åŸè§†é¢‘';
        restoreButton.style.display = 'none';

        // VIPè§£ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
        vipButton.onclick = function() {
            const iframe = createVideoPlayer();
            if (iframe) {
                // éšè—VIPæŒ‰é’®
                vipButton.style.display = 'none';
                // å°†æ¢å¤æŒ‰é’®æ·»åŠ åˆ°æ’­æ”¾å™¨å®¹å™¨ä¸­
                const container = getPlayerContainer();
                if (container) {
                    container.appendChild(restoreButton);
                    restoreButton.style.display = 'block';
                }
            }
        };

        // æ¢å¤åŸè§†é¢‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        restoreButton.onclick = function() {
            restoreOriginalVideo();
            // æ˜¾ç¤ºVIPæŒ‰é’®
            vipButton.style.display = 'block';
            // ç§»é™¤æ¢å¤æŒ‰é’®
            restoreButton.remove();
        };
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘ç½‘ç«™
    function isVideoSite() {
        const hostname = window.location.hostname;
        return Object.keys(playerConfig).some(site => hostname.includes(site));
    }

    // åˆå§‹åŒ–
    function init() {
        if (isVideoSite()) {
            // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
            setTimeout(createButtons, 2000);
        }
    }

    // å¯åŠ¨è„šæœ¬
    init();
})();
